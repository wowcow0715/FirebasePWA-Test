<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Firebase 推播測試</title>
    <link rel="manifest" href="manifest.json">
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-messaging.js";
        import { getAnalytics, logEvent } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-analytics.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDZklXfy-QFX2aFxveT-rubiSamhRLL3S4",
            authDomain: "best777h5.firebaseapp.com",
            projectId: "best777h5",
            storageBucket: "best777h5.firebasestorage.app",
            messagingSenderId: "129060872565",
            appId: "1:129060872565:web:b81c63bd4a65c8eb73b33c",
            measurementId: "G-49JKD0RD91"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const messaging = getMessaging(app);

        // 複製 Token 到剪貼簿
        window.copyToken = async function() {
            const token = document.getElementById('token').textContent;
            if (!token) {
                alert('尚未取得 Token');
                return;
            }

            try {
                await navigator.clipboard.writeText(token);
                // 顯示複製成功訊息
                const successMsg = document.getElementById('copySuccess');
                successMsg.style.display = 'inline';
                // 3秒後隱藏訊息
                setTimeout(() => {
                    successMsg.style.display = 'none';
                }, 3000);

                // 記錄成功複製事件
                logEvent(analytics, 'token_copied', {
                    success: true
                });
            } catch (err) {
                console.error('複製失敗:', err);
                alert('複製失敗，請手動複製');

                // 記錄複製失敗事件
                logEvent(analytics, 'token_copy_error', {
                    error_message: err.message
                });
            }
        }

        // 檢查通知權限
        async function checkNotificationPermission() {
            const permission = await Notification.requestPermission();
            console.log('目前通知權限狀態:', permission);
            
            // 更新權限狀態顯示
            document.getElementById('permissionStatus').textContent = `通知權限: ${permission}`;
            
            if (permission === 'granted') {
                // 如果同意了，就取得 Token
                requestToken();
            } else if (permission === 'denied') {
                document.getElementById('token').textContent = '需要通知權限才能取得 Token';
            }
        }

        // 修改 requestToken 函數，移除權限請求部分
        async function requestToken() {
            console.log('開始取得 FCM Token...');
            try {
                console.log('註冊 Service Worker...');
                const registration = await navigator.serviceWorker.register('/FirebasePWA-Test/firebase-messaging-sw.js', {
                    scope: '/FirebasePWA-Test/'
                });
                console.log('Service Worker 註冊成功:', registration);

                const token = await getToken(messaging, {
                    vapidKey: 'BJ19liz5V-TS-u0YGubW_zbueEg9qi0k0emBpnCFjBnFBk1vhGjClblqhlIAxZqe5JMF1IBAzmhOBUadsL9_RB8',
                    serviceWorkerRegistration: registration
                });
                
                console.log('FCM Token 取得成功:', {
                    token: token,
                    tokenLength: token.length,
                    timestamp: new Date().toISOString()
                });
                
                document.getElementById('token').textContent = token;

                logEvent(analytics, 'fcm_token_obtained', {
                    success: true,
                    token_length: token.length
                });
            } catch (error) {
                console.error('Token 取得失敗:', error);
                document.getElementById('token').textContent = '取得 Token 失敗: ' + error.message;

                logEvent(analytics, 'fcm_token_error', {
                    error_message: error.message,
                    error_code: error.code || 'unknown'
                });
            }
        }

        // 將 requestToken 和 checkNotificationPermission 加到 window 物件
        window.requestToken = requestToken;
        window.checkNotificationPermission = checkNotificationPermission;

        // 修改前景訊息處理，只記錄不顯示通知
        onMessage(messaging, (payload) => {
            console.log('收到訊息:', payload);
            
            // 記錄前景推播接收
            logEvent(analytics, 'foreground_push_received', {
                title: payload.notification?.title || 'no_title',
                body: payload.notification?.body || 'no_body',
                has_data: !!payload.data,
                timestamp: new Date().toISOString(),
                message_type: payload.data ? 'data' : 'notification'
            });
            
            if (payload.data) {
                console.log('收到數據:', payload.data);
                // 記錄數據類型推播
                logEvent(analytics, 'push_data_received', {
                    data_type: payload.data.type || 'unknown',
                    has_url: !!payload.data.url,
                    timestamp: new Date().toISOString()
                });
            }
        });

        // 檢查iOS版本
        function checkIOSVersion() {
            const match = navigator.userAgent.match(/OS (\d+)_(\d+)_?(\d+)?/);
            return match ? parseFloat(match[1] + '.' + match[2]) : false;
        }

        // 錯誤處理
        window.addEventListener('error', (event) => {
            console.error('PWA錯誤:', event.error);
            // 實作適當的錯誤處理邏輯
        });
    </script>

    <style>
        .container {
            margin: 20px;
        }
        .token-container {
            display: flex;
            align-items: center;
            margin-top: 10px;
            gap: 10px;
        }
        .token-input {
            min-width: 300px;
            padding: 5px;
        }
        .button {
            padding: 5px 10px;
            cursor: pointer;
        }
        #copySuccess {
            color: green;
            display: none;
        }
        .button-container {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        .permission-status {
            margin-top: 10px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>Firebase 推播測試</h1>
    <div class="button-container">
        <button onclick="checkNotificationPermission()">請求通知權限</button>
        <button onclick="requestToken()" id="getTokenBtn">重新取得 Token</button>
    </div>
    <div class="permission-status">
        <span id="permissionStatus">通知權限: 未請求</span>
    </div>
    <div class="token-container">
        <span>FCM Token: </span>
        <span id="token"></span>
        <button class="copy-button" onclick="copyToken()">複製 Token</button>
        <span id="copySuccess">複製成功！</span>
    </div>
</body>
</html> 